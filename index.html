<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maths Astro Academy</title>
    <style>
        :root {
            --primary: #6C63FF;
            --secondary: #FF6584;
            --accent: #00E5FF;
            --dark-bg: #1a1a2e;
            --card-bg: #ffffff;
        }

        /* 1. RESET & LAYOUT */
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            margin: 0;
            height: 100vh;
            overflow: hidden; /* No scrolling */
            display: flex;
            justify-content: center;
        }

        .stars {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            pointer-events: none;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px);
            background-size: 550px 550px, 350px 350px;
        }

        /* 2. APP CONTAINER - MOBILE OPTIMIZED */
        .app-container {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 500px; /* Constrain width on tablets */
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        /* SCREENS */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            animation: fadeIn 0.3s ease;
        }
        .screen.active { display: flex; }

        /* START SCREEN */
        .menu-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            border: 4px solid var(--primary);
            margin: auto; /* Center in screen */
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        h1 { color: var(--primary); margin: 10px 0; font-size: 1.8rem; }
        
        .year-btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-year {
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 15px 5px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-year:active { background: var(--primary); color: white; transform: scale(0.95); }

        /* GAME LAYOUT - FIXING THE GAP */
        .game-header {
            display: flex; justify-content: space-between; align-items: center;
            color: white; font-weight: bold; height: 50px; flex-shrink: 0;
        }

        .btn-quit {
            background: var(--secondary); color: white; border: none;
            padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer;
        }

        /* Wrapper to center content vertically */
        .game-content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center; /* This centers everything vertically */
            gap: 15px; /* Consistent small gap between question and keys */
            padding-bottom: 20px;
        }

        /* QUESTION CARD */
        .question-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .question-text { font-size: 3rem; color: #333; font-weight: bold; margin-bottom: 10px; }
        
        .answer-display {
            background: #f4f4f4;
            border: 3px solid #ddd;
            border-radius: 12px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        .answer-display.active { border-color: var(--accent); background: white; }

        .feedback-msg { height: 25px; margin-top: 10px; font-weight: bold; font-size: 1.2rem; }
        .correct { color: #00C851; }
        .wrong { color: var(--secondary); }

        /* NUMPAD - BIGGER BUTTONS */
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .key-btn {
            background: white;
            border: none;
            border-radius: 15px;
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 0 #bbb;
            cursor: pointer;
            height: 65px; /* Fixed height for touch targets */
            transition: transform 0.1s;
        }
        
        .key-btn:active { transform: translateY(4px); box-shadow: none; background: #eee; }
        .key-btn.special { background: var(--secondary); color: white; box-shadow: 0 4px 0 #c23a54; }
        .key-btn.enter { background: var(--primary); color: white; box-shadow: 0 4px 0 #4a43b8; }

        /* RESULTS */
        .btn-restart {
            width: 100%; padding: 15px;
            background: var(--primary); color: white;
            border: none; border-radius: 50px;
            font-size: 1.3rem; margin-top: 20px; cursor: pointer;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

        /* Tablet/Desktop Tweaks */
        @media (min-height: 800px) {
            .question-text { font-size: 4rem; margin-bottom: 20px; }
            .key-btn { height: 80px; }
            .game-content-wrapper { gap: 30px; }
        }
    </style>
</head>
<body>

<div class="stars"></div>

<div class="app-container">
    
    <div id="screen-setup" class="screen active">
        <div class="menu-panel">
            <h1>üöÄ Astro Maths</h1>
            <p>Select your Mission:</p>
            <div class="year-btn-grid" id="year-menu">
                </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-header">
            <button class="btn-quit" onclick="quitGame()">‚ùå Quit</button>
            <span id="lbl-year">Year 3</span>
            <span>‚≠ê <span id="lbl-score">0</span></span>
        </div>

        <div class="game-content-wrapper">
            <div class="question-card">
                <div class="question-text" id="question">?</div>
                <div class="answer-display" id="display"></div>
                <div class="feedback-msg" id="feedback"></div>
            </div>

            <div class="numpad">
                <button class="key-btn" onclick="input('1')">1</button>
                <button class="key-btn" onclick="input('2')">2</button>
                <button class="key-btn" onclick="input('3')">3</button>
                <button class="key-btn" onclick="input('4')">4</button>
                <button class="key-btn" onclick="input('5')">5</button>
                <button class="key-btn" onclick="input('6')">6</button>
                <button class="key-btn" onclick="input('7')">7</button>
                <button class="key-btn" onclick="input('8')">8</button>
                <button class="key-btn" onclick="input('9')">9</button>
                <button class="key-btn special" onclick="input('DEL')">DEL</button>
                <button class="key-btn" onclick="input('0')">0</button>
                <button class="key-btn enter" onclick="checkAnswer()">GO</button>
            </div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="menu-panel">
            <h1>Mission Complete!</h1>
            <p>Score: <strong id="res-score" style="font-size:1.5rem">0</strong></p>
            <p>High Score: <strong id="res-high">0</strong></p>
            <button class="btn-restart" onclick="showSetup()">Play Again üîÑ</button>
        </div>
    </div>

</div>

<script>
    // --- 1. CONFIGURATION ---
    const years = [
        { id: 0, label: "Reception", desc: "Add to 10" },
        { id: 1, label: "Year 1", desc: "Add/Sub to 20" },
        { id: 2, label: "Year 2", desc: "Tables 2,5,10" },
        { id: 3, label: "Year 3", desc: "x3,x4,x8 & 3-Digit" },
        { id: 4, label: "Year 4", desc: "Tables up to 12" },
        { id: 5, label: "Year 5", desc: "Big Mix" },
        { id: 6, label: "Year 6", desc: "Expert" }
    ];

    let state = {
        active: false,
        year: 0,
        score: 0,
        inputStr: "",
        q: { text: "", ans: 0 },
        qCount: 0
    };

    // --- 2. AUDIO SYSTEM (Fixes Sound Issues) ---
    let audioCtx = null;

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function playSound(type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'tap') {
            osc.frequency.setValueAtTime(600, now);
            gain.gain.setValueAtTime(0.05, now);
            osc.stop(now + 0.05);
        } else if (type === 'correct') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.linearRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.stop(now + 0.3);
        } else if (type === 'wrong') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, now);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.stop(now + 0.3);
        }
        osc.start(now);
    }

    // --- 3. INIT ---
    // Create Menu Buttons
    const menuDiv = document.getElementById('year-menu');
    years.forEach(y => {
        let btn = document.createElement('button');
        btn.className = 'btn-year';
        btn.innerHTML = `${y.label}<br><small>${y.desc}</small>`;
        btn.onclick = () => startGame(y.id);
        menuDiv.appendChild(btn);
    });

    // --- 4. GAME LOGIC ---
    function startGame(id) {
        // Initialize Audio on first user interaction
        initAudio();

        state.year = id;
        state.score = 0;
        state.qCount = 0;
        state.active = true;
        
        document.getElementById('lbl-year').innerText = years[id].label;
        document.getElementById('lbl-score').innerText = "0";
        
        switchScreen('screen-game');
        nextQuestion();
    }

    function nextQuestion() {
        if (state.qCount >= 10) {
            endGame();
            return;
        }
        state.qCount++;
        state.inputStr = "";
        state.q = generateMath(state.year);
        
        // Reset UI
        document.getElementById('question').innerText = state.q.text;
        document.getElementById('feedback').innerText = "";
        document.getElementById('display').classList.remove('active');
        updateDisplay();
        state.active = true; // Unlock input
    }

    function generateMath(year) {
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        let n1, n2, op, text, ans;
        let r = Math.random();

        switch(year) {
            case 0: n1=randInt(1,5); n2=randInt(1,4); op='+'; break;
            case 1: op=r>0.5?'+':'-'; n1=randInt(5,20); n2=randInt(1,9); break;
            case 2: 
                if(r>0.6){ n1=[2,5,10][randInt(0,2)]; n2=randInt(1,12); op='x'; }
                else { op=r>0.8?'-':'+'; n1=randInt(10,50); n2=randInt(2,20); }
                break;
            case 3: // Year 3
                if(r>0.5) { n1=[3,4,8][randInt(0,2)]; n2=randInt(1,12); op='x'; }
                else { 
                    op=r>0.7?'-':'+'; 
                    if(op==='+'){ n1=randInt(100,500); n2=randInt(10,300); }
                    else { n1=randInt(200,800); n2=randInt(10,150); }
                }
                break;
            case 4: n1=randInt(2,12); n2=randInt(2,12); op='x'; break;
            default:
                if(r>0.6){ n1=randInt(100,900); n2=randInt(50,400); op=r>0.8?'-':'+'; }
                else { n1=randInt(3,15); n2=randInt(10,50); op='x'; }
        }

        // Safety for negatives
        if(op==='-' && n1<n2) [n1,n2]=[n2,n1];

        if(op==='+') ans=n1+n2;
        if(op==='-') ans=n1-n2;
        if(op==='x') ans=n1*n2;

        return { text: `${n1} ${op==='x'?'√ó':op} ${n2} = ?`, ans: ans };
    }

    // --- 5. INPUT HANDLING ---
    function input(val) {
        if (!state.active) return;
        
        if (val === 'DEL') {
            state.inputStr = state.inputStr.slice(0, -1);
        } else {
            // LIMIT INPUT TO 4 DIGITS
            if (state.inputStr.length < 4) {
                state.inputStr += val;
            }
        }
        playSound('tap');
        updateDisplay();
    }

    function updateDisplay() {
        let disp = document.getElementById('display');
        disp.innerText = state.inputStr;
        if(state.inputStr.length > 0) disp.classList.add('active');
        else disp.classList.remove('active');
    }

    function checkAnswer() {
        if (!state.active || state.inputStr === "") return;
        
        let userAns = parseInt(state.inputStr);
        let fb = document.getElementById('feedback');
        
        if (userAns === state.q.ans) {
            // CORRECT
            state.active = false; // Lock input
            state.score += 10;
            document.getElementById('lbl-score').innerText = state.score;
            fb.innerText = "Correct! üåü";
            fb.className = "feedback-msg correct";
            playSound('correct');
            
            // AUTO ADVANCE
            setTimeout(() => {
                nextQuestion();
            }, 1000);

        } else {
            // WRONG
            fb.innerText = "Try again!";
            fb.className = "feedback-msg wrong";
            document.getElementById('display').classList.add('shake');
            playSound('wrong');
            state.inputStr = "";
            setTimeout(() => {
                document.getElementById('display').classList.remove('shake');
                updateDisplay();
            }, 400);
        }
    }

    function endGame() {
        const key = `astro_high_${state.year}`;
        const high = parseInt(localStorage.getItem(key)||0);
        if(state.score > high) localStorage.setItem(key, state.score);

        document.getElementById('res-score').innerText = state.score;
        document.getElementById('res-high').innerText = Math.max(state.score, high);
        switchScreen('screen-result');
        playSound('correct');
    }

    // --- 6. UTILS ---
    function quitGame() {
        if(confirm("Exit Mission?")) showSetup();
    }

    function showSetup() {
        switchScreen('screen-setup');
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

</script>
</body>
</html>
