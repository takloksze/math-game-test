<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maths Astro Academy: Universal Edition</title>
    <style>
        :root {
            --primary: #6C63FF;
            --secondary: #FF6584;
            --accent: #00E5FF;
            --dark: #1a1a2e;
            --panel: rgba(255, 255, 255, 0.95);
            --font: 'Segoe UI', 'Roboto', sans-serif;
        }

        * { box-sizing: border-box; touch-action: manipulation; }

        body {
            font-family: var(--font);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: #333;
        }

        /* Animated Background */
        .stars {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px);
            background-size: 550px 550px, 350px 350px;
            background-position: 0 0, 40px 60px;
        }

        /* Main Container */
        .app-container {
            width: 100%;
            max-width: 600px;
            height: 100vh;
            max-height: 900px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Screens */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        .screen.active { display: flex; }

        /* Start Screen */
        .title-card {
            background: var(--panel);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin: auto;
            border: 4px solid var(--primary);
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        h1 { color: var(--primary); margin: 0 0 10px 0; font-size: 2rem; }
        
        .grid-menu {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-year {
            background: white;
            border: 3px solid var(--primary);
            color: var(--primary);
            padding: 15px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .btn-year:hover { background: #f0efff; transform: translateY(-2px); }
        .btn-year:active { transform: scale(0.95); background: var(--primary); color: white; }

        /* Game Screen */
        .game-header {
            display: flex; justify-content: space-between; align-items: center;
            color: white; padding: 10px; font-size: 1.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .game-display {
            background: var(--panel);
            border-radius: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            position: relative;
        }

        .question-text { font-size: 3.5rem; color: var(--dark); font-weight: bold; margin-bottom: 20px; text-align: center; }
        
        .answer-box {
            min-width: 150px;
            height: 80px;
            padding: 0 20px;
            background: #f0f2f5;
            border: 4px solid #ccc;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--primary);
            font-weight: bold;
            transition: border-color 0.2s;
        }
        .answer-box.active { border-color: var(--accent); background: white; box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); }
        
        .feedback-msg { height: 30px; margin-top: 15px; font-weight: bold; font-size: 1.3rem; }
        .correct { color: #00C851; }
        .wrong { color: var(--secondary); }

        /* Numpad */
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 0 10px 20px 10px;
        }
        .num-btn {
            background: white;
            border: none;
            border-radius: 15px;
            height: 65px;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--dark);
            box-shadow: 0 4px 0 #ccc;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .num-btn:hover { background: #f9f9f9; }
        .num-btn:active, .num-btn.pressed { transform: translateY(4px); box-shadow: 0 0 0 #ccc; }
        
        .btn-enter { background: var(--primary); color: white; box-shadow: 0 4px 0 #4a43b8; }
        .btn-enter:hover { background: #5b54d6; }
        
        .btn-del { background: var(--secondary); color: white; box-shadow: 0 4px 0 #d93d5e; }
        .btn-del:hover { background: #ff4f73; }

        /* Results */
        .results-card {
            background: var(--panel);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin: auto;
            width: 90%;
            border: 4px solid var(--primary);
        }
        .stat-row { display: flex; justify-content: space-between; margin: 15px 0; font-size: 1.2rem; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        
        .btn-action {
            width: 100%; padding: 20px;
            background: var(--primary); color: white;
            border: none; border-radius: 50px;
            font-size: 1.5rem; margin-top: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108, 99, 255, 0.4); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .shake { animation: shake 0.4s ease-in-out; border-color: var(--secondary) !important; color: var(--secondary); }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .pop { animation: pop 0.3s ease-in-out; }
        @keyframes pop { 50% { transform: scale(1.2); } }
        
        /* Mobile Adjustment */
        @media (max-height: 700px) {
            .question-text { font-size: 2.5rem; margin-bottom: 10px; }
            .answer-box { height: 60px; font-size: 2.5rem; }
            .num-btn { height: 55px; }
            .game-display { margin: 5px 0; }
        }
    </style>
</head>
<body>

<div class="stars"></div>

<div class="app-container">
    
    <div id="screen-start" class="screen active">
        <div class="title-card">
            <h1>üöÄ Astro Maths</h1>
            <p>Select Your Mission</p>
            <div class="grid-menu" id="year-menu">
                </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-header">
            <span id="badge-year">Year 3</span>
            <span>‚≠ê <span id="score">0</span></span>
            <span>‚è±Ô∏è <span id="timer">60</span>s</span>
        </div>

        <div class="game-display">
            <div class="question-text" id="question">?</div>
            <div class="answer-box" id="display-answer"></div>
            <div class="feedback-msg" id="feedback"></div>
        </div>

        <div class="numpad">
            <button class="num-btn" data-key="1">1</button>
            <button class="num-btn" data-key="2">2</button>
            <button class="num-btn" data-key="3">3</button>
            <button class="num-btn" data-key="4">4</button>
            <button class="num-btn" data-key="5">5</button>
            <button class="num-btn" data-key="6">6</button>
            <button class="num-btn" data-key="7">7</button>
            <button class="num-btn" data-key="8">8</button>
            <button class="num-btn" data-key="9">9</button>
            <button class="num-btn btn-del" data-key="DEL">DEL</button>
            <button class="num-btn" data-key="0">0</button>
            <button class="num-btn btn-enter" data-key="ENTER">GO</button>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="results-card">
            <h1 id="result-title">Mission Complete!</h1>
            <div class="stat-row">
                <span>Total Score:</span>
                <strong id="final-score">0</strong>
            </div>
            <div class="stat-row">
                <span>High Score:</span>
                <strong id="high-score">0</strong>
            </div>
            <div class="stat-row">
                <span>Questions:</span>
                <strong id="total-questions">0</strong>
            </div>
            
            <button class="btn-action" id="btn-restart">Play Again üîÑ</button>
        </div>
    </div>

</div>

<script>
    // --- GAME CONFIGURATION ---
    const years = [
        { id: 0, label: "Reception", desc: "Add to 10" },
        { id: 1, label: "Year 1", desc: "Add/Sub to 20" },
        { id: 2, label: "Year 2", desc: "Tables 2,5,10" },
        { id: 3, label: "Year 3", desc: "x3,x4,x8 & 3-Digit" },
        { id: 4, label: "Year 4", desc: "Tables up to 12" },
        { id: 5, label: "Year 5", desc: "Big Mix" },
        { id: 6, label: "Year 6", desc: "Expert" }
    ];

    // --- STATE MANAGEMENT ---
    let state = {
        year: 0,
        score: 0,
        timer: 60,
        active: false,
        currentQ: { n1:0, n2:0, op:'+', ans:0 },
        input: "",
        interval: null,
        questionsAnswered: 0
    };

    // --- AUDIO SYSTEM ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;
        if (type === 'tap') {
            osc.frequency.setValueAtTime(600, now);
            gain.gain.setValueAtTime(0.05, now);
            osc.stop(now + 0.05);
        } else if (type === 'correct') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(500, now);
            osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.stop(now + 0.3);
        } else if (type === 'wrong') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(300, now);
            osc.frequency.linearRampToValueAtTime(100, now + 0.2);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.stop(now + 0.2);
        }
        osc.start(now);
    }

    // --- INITIALIZATION ---
    function init() {
        // Generate Menu
        const menu = document.getElementById('year-menu');
        years.forEach(y => {
            const btn = document.createElement('div');
            btn.className = 'btn-year';
            btn.innerHTML = `${y.label}<br><small style="font-weight:normal; font-size:0.8em">${y.desc}</small>`;
            btn.addEventListener('click', () => startGame(y.id));
            menu.appendChild(btn);
        });

        // Attach On-Screen Numpad Listeners
        document.querySelectorAll('.num-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Prevent double firing on some touch devices
                e.preventDefault(); 
                const key = btn.getAttribute('data-key');
                handleInput(key);
                
                // Visual feedback for click
                btn.classList.add('pressed');
                setTimeout(() => btn.classList.remove('pressed'), 100);
            });
        });

        // Restart Button
        document.getElementById('btn-restart').addEventListener('click', showStartScreen);

        // Attach Physical Keyboard Listeners
        document.addEventListener('keydown', (e) => {
            if (!state.active) return;
            
            if (e.key >= '0' && e.key <= '9') {
                handleInput(e.key);
                simulateButtonPress(e.key);
            } else if (e.key === 'Enter') {
                handleInput('ENTER');
                simulateButtonPress('ENTER');
            } else if (e.key === 'Backspace' || e.key === 'Delete') {
                handleInput('DEL');
                simulateButtonPress('DEL');
            }
        });
    }

    function simulateButtonPress(key) {
        const btn = document.querySelector(`.num-btn[data-key="${key}"]`);
        if (btn) {
            btn.classList.add('pressed');
            setTimeout(() => btn.classList.remove('pressed'), 100);
        }
    }

    // --- GAME LOGIC ---
    function startGame(yearId) {
        state.year = yearId;
        state.score = 0;
        state.timer = 60;
        state.questionsAnswered = 0;
        state.active = true;
        state.input = "";

        // UI Reset
        switchScreen('screen-game');
        document.getElementById('badge-year').innerText = years[yearId].label;
        document.getElementById('score').innerText = "0";
        document.getElementById('feedback').innerText = "";
        
        nextQuestion();
        startTimer();
    }

    function generateMath(year) {
        let n1, n2, op, ans;
        const rand = Math.random();
        const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        switch(year) {
            case 0: // Reception
                n1 = randInt(1, 5); n2 = randInt(1, 4); op = '+';
                break;
            case 1: // Year 1
                op = rand > 0.5 ? '+' : '-';
                n1 = randInt(5, 20); n2 = randInt(1, 9);
                if (op === '-' && n1 < n2) [n1, n2] = [n2, n1];
                break;
            case 2: // Year 2
                if (rand > 0.6) { // Tables 2,5,10
                    n1 = [2,5,10][randInt(0,2)];
                    n2 = randInt(1, 12);
                    op = 'x';
                } else { // Add/Sub 2-digit
                    op = rand > 0.8 ? '-' : '+';
                    n1 = randInt(10, 50); n2 = randInt(2, 20);
                }
                break;
            case 3: // YEAR 3
                if (rand > 0.5) {
                    // Times Tables 3, 4, 8
                    n1 = [3,4,8][randInt(0,2)];
                    n2 = randInt(1, 12);
                    op = 'x';
                } else {
                    // 3-Digit Addition/Subtraction
                    op = rand > 0.75 ? '-' : '+';
                    if(op === '+') {
                        n1 = randInt(100, 500);
                        n2 = randInt(10, 300);
                    } else {
                        n1 = randInt(200, 800);
                        n2 = randInt(10, 150);
                    }
                }
                break;
            case 4: // Year 4
                n1 = randInt(2, 12); n2 = randInt(2, 12); op = 'x';
                break;
            default: // Year 5/6
                if(rand > 0.6) {
                     n1 = randInt(100, 900); n2 = randInt(50, 400); 
                     op = rand > 0.8 ? '-' : '+';
                } else {
                     n1 = randInt(3, 15); n2 = randInt(10, 50); op = 'x';
                }
                break;
        }

        if (op === '+') ans = n1 + n2;
        if (op === '-') { if(n1 < n2) [n1, n2] = [n2, n1]; ans = n1 - n2; }
        if (op === 'x') ans = n1 * n2;

        return { n1, n2, op: op === 'x' ? '√ó' : op, ans };
    }

    function nextQuestion() {
        state.currentQ = generateMath(state.year);
        state.input = "";
        updateDisplay();
    }

    // --- UNIFIED INPUT HANDLER ---
    function handleInput(key) {
        if (!state.active) return;

        if (key === 'ENTER') {
            checkAnswer();
        } else if (key === 'DEL') {
            state.input = state.input.slice(0, -1);
            playSound('tap');
            updateDisplay();
        } else {
            // Numbers 0-9
            if (state.input.length < 6) { 
                state.input += key;
                playSound('tap');
                updateDisplay();
            }
        }
    }

    function updateDisplay() {
        const q = state.currentQ;
        document.getElementById('question').innerText = `${q.n1} ${q.op} ${q.n2}`;
        const display = document.getElementById('display-answer');
        display.innerText = state.input;
        
        if(state.input.length > 0) display.classList.add('active');
        else display.classList.remove('active');
    }

    function checkAnswer() {
        if (!state.active || state.input === "") return;
        
        const userAns = parseInt(state.input);
        const correct = state.currentQ.ans === userAns;
        const feedback = document.getElementById('feedback');

        if (correct) {
            playSound('correct');
            state.score += 10;
            state.questionsAnswered++;
            document.getElementById('score').innerText = state.score;
            feedback.innerText = "Correct! üåü";
            feedback.className = "feedback-msg correct pop";
            
            setTimeout(() => {
                feedback.className = "feedback-msg";
                nextQuestion();
            }, 500);
        } else {
            playSound('wrong');
            const display = document.getElementById('display-answer');
            display.classList.add('shake');
            feedback.innerText = "Try again!";
            feedback.className = "feedback-msg wrong";
            state.input = "";
            setTimeout(() => {
                display.classList.remove('shake');
                updateDisplay();
            }, 400);
        }
    }

    // --- TIMER & END GAME ---
    function startTimer() {
        if(state.interval) clearInterval(state.interval);
        const timerEl = document.getElementById('timer');
        
        state.interval = setInterval(() => {
            state.timer--;
            timerEl.innerText = state.timer;
            
            if (state.timer <= 0) {
                endGame();
            }
        }, 1000);
    }

    function endGame() {
        state.active = false;
        clearInterval(state.interval);
        
        const key = `astro_math_high_${state.year}`;
        const prevHigh = parseInt(localStorage.getItem(key) || 0);
        if (state.score > prevHigh) localStorage.setItem(key, state.score);

        document.getElementById('final-score').innerText = state.score;
        document.getElementById('high-score').innerText = Math.max(state.score, prevHigh);
        document.getElementById('total-questions').innerText = state.questionsAnswered;
        
        switchScreen('screen-result');
        createConfetti();
        playSound('correct'); 
    }

    function showStartScreen() {
        switchScreen('screen-start');
    }

    function switchScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function createConfetti() {
        const colors = ['#6C63FF', '#FF6584', '#00E5FF', '#FFFF00'];
        for(let i=0; i<50; i++) {
            const div = document.createElement('div');
            div.style.position = 'fixed';
            div.style.left = Math.random() * 100 + 'vw';
            div.style.top = '-10px';
            div.style.width = '10px';
            div.style.height = '10px';
            div.style.background = colors[Math.floor(Math.random() * colors.length)];
            div.style.transition = 'top 2s ease-in, transform 2s';
            div.style.zIndex = '9999';
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.style.top = '110vh';
                div.style.transform = `rotate(${Math.random()*720}deg)`;
            }, 10);
            setTimeout(() => div.remove(), 2100);
        }
    }

    // Start App
    init();

</script>
</body>
</html>
